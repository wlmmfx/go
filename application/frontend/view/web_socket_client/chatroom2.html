<style type="text/css">
    .chat-room-container {
        font-family: "Courier New";
        width: 680px;
        height: 300px;
        overflow: auto;
        border: 1px solid black;
        padding: 10px 0px 0px 10px;
    }

    .LockOff {
        display: none;
        visibility: hidden;
    }

    .LockOn {
        display: block;
        visibility: visible;
        position: absolute;
        z-index: 999;
        top: 0px;
        left: 0px;
        width: 1024%;
        height: 768%;
        background-color: #ccc;
        text-align: center;
        padding-top: 20%;
        filter: alpha(opacity=75);
        opacity: 0.75;
    }
</style>
<script type="text/javascript">
    var ws;
    var wsServerIP = "115.29.8.55";
    var wsServerPort = "12345";
    var SocketCreated = false;
    var isUserloggedout = false;

    function lockOn(str) {
        var lock = document.getElementById('skm_LockPane');
        if (lock)
            lock.className = 'LockOn';
        lock.innerHTML = str;
    }

    function lockOff() {
        var lock = document.getElementById('skm_LockPane');
        lock.className = 'LockOff';
    }

    function ToggleConnectionClicked() {
        if (SocketCreated && (ws.readyState == 0 || ws.readyState == 1)) {
            lockOn("离开聊天室...");
            SocketCreated = false;
            isUserloggedout = true;
            ws.close();
        } else {
            lockOn("进入聊天室...");
//            Log("准备连接到聊天服务器 ...");
            try {
                if ("WebSocket" in window) {
                    ws = new WebSocket("ws://" +wsServerIP+":"+wsServerPort);
                }
                else if ("MozWebSocket" in window) {
                    ws = new MozWebSocket("ws://" +wsServerIP+":"+wsServerPort);
                }
                SocketCreated = true;
                isUserloggedout = false;
            } catch (ex) {
                Log(ex, "ERROR");
                return;
            }
            document.getElementById("ToggleConnection").innerHTML = "断开";
            ws.onopen = WSonOpen;
            ws.onmessage = WSonMessage;
            ws.onclose = WSonClose;
            ws.onerror = WSonError;
        }
    };

    /**
     * 连接成功
     * @constructor
     */
    function WSonOpen() {
        lockOff();
        Log("连接已经建立。", "OK");
        $("#SendDataContainer").show();
        var $txtName = document.getElementById("txtName").value;
        var wsSend = {"name": $txtName ,"password":"1123213"};
        ws.send(JSON.stringify(wsSend));
    };

    function WSonMessage(event) {
        Log(event.data);
    };

    function WSonClose() {
        lockOff();
        if (isUserloggedout)
            Log("【" + document.getElementById("txtName").value + "】离开了聊天室！");
        document.getElementById("ToggleConnection").innerHTML = "连接";
        $("#SendDataContainer").hide();
    };

    function WSonError() {
        lockOff();
        Log("远程连接中断。", "ERROR");
    };

    function SendDataClicked() {
        if (document.getElementById("DataToSend").value.trim() != "") {
            ws.send(document.getElementById("DataToSend").value + "\"");
            document.getElementById("DataToSend").value = "";
        }
    };

    function Log(Text, MessageType) {
        if (MessageType == "OK") Text = "<span style='color: green;'>" + Text + "</span>";
        if (MessageType == "ERROR") Text = "<span style='color: red;'>" + Text + "</span>";
        document.getElementById("LogContainer").innerHTML = document.getElementById("LogContainer").innerHTML + Text + "<br />";
        var LogContainer = document.getElementById("LogContainer");
        LogContainer.scrollTop = LogContainer.scrollHeight;
    };

    $(document).ready(function () {
        var WebSocketsExist = true;
        try {
            var dummy = new WebSocket("ws://115.29.8.55:12345");
        } catch (ex) {
            try {
                webSocket = new MozWebSocket("ws://115.29.8.55:12345");
            }
            catch (ex) {
                WebSocketsExist = false;
            }
        }

        if (WebSocketsExist) {
            Log("您的浏览器支持WebSocket. 您可以尝试连接到聊天服务器!", "OK");
        } else {
            Log("您的浏览器不支持WebSocket。请选择其他的浏览器再尝试连接服务器。", "ERROR");
            document.getElementById("ToggleConnection").disabled = true;
        }

        $("#DataToSend").keypress(function (evt) {
            if (evt.keyCode == 13) {
                $("#SendData").click();
                evt.preventDefault();
            }
        })
    });

</script>
<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.slim.js"></script>
<div class="container">
    <ul class="breadcrumb">
        <li><a href="/">首页</a></li>
        <li class="active">搜索</li>
    </ul>
    <!-- 简介 -->
    <div class="row">
        <div id="skm_LockPane" class="LockOff"></div>
        <form id="form1" runat="server">
            <h1>Web Socket 聊天室</h1>
            <br/>

            用户名： <input type="text" id="txtName" value="贰萬"/>
            <button id='ToggleConnection' type="button" onclick='ToggleConnectionClicked();'>连接</button>
            <br/>
            <br/>
            <div id='LogContainer' class='chat-room-container'></div>
            <br/>
            <div id='SendDataContainer'>
                <input type="text" id="DataToSend" size="88"/>
                <button id='SendData' type="button" onclick='SendDataClicked();'>发送</button>
            </div>
            <br/>
        </form>
    </div>
</div>